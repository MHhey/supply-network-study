<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Supplier Selection Research Study</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:#fff; color:#022b3a; line-height:1.6; }
.container { max-width:1400px; margin:0 auto; background:#fff; }
.header { background:#022b3a; color:#fff; padding:20px; text-align:center; }
.header h1 { font-size:2rem; font-weight:600; margin-bottom:8px; }
.header p { opacity:.9; font-size:1.1rem; }
.scenario-bar { background:#e1e5f2; padding:20px; border-bottom:1px solid #bfdbf7; }
.scenario-info { max-width:1400px; margin:0 auto; display:flex; flex-direction:column; gap:15px; }
.week-info { display:flex; justify-content:space-between; align-items:center; }
.week-badge { background:#1f7a8c; color:#fff; padding:8px 16px; border-radius:20px; font-weight:600; }
.scenario-description { color:#1f7a8c; font-size:.9rem; text-align:right; }
.chevron-progress { display:flex; align-items:center; justify-content:center; height:60px; margin-top:10px; }
.chevron-container { position:relative; height:50px; margin-right:-1px; display:flex; align-items:center; }
.chevron { height:50px; width:160px; position:relative; display:flex; align-items:center; justify-content:center; font-weight:600; font-size:.9rem;
  clip-path:polygon(0 0, calc(100% - 15px) 0, 100% 50%, calc(100% - 15px) 100%, 0 100%, 15px 50%); transition:all .3s ease; }
.chevron.baseline { clip-path:polygon(0 0, calc(100% - 15px) 0, 100% 50%, calc(100% - 15px) 100%, 0 100%); }
.chevron.completed { background:#022b3a; color:#fff; }
.chevron.active { background:#1f7a8c; color:#fff; }
.chevron.locked { background:#e1e5f2; color:#bfdbf7; }
.chevron-progress-bar { position:absolute; bottom:2px; left:15px; right:15px; height:4px; background:rgba(255,255,255,.3); border-radius:2px; overflow:hidden; }
.chevron.baseline .chevron-progress-bar { left:5px; }
.chevron-progress-fill { height:100%; background:rgba(255,255,255,.9); border-radius:2px; transition:width .3s ease; width:0%; }
.chevron.locked .chevron-progress-bar, .chevron.locked .chevron-progress-fill { background:rgba(191,219,247,.3); }
.main-content { display:flex; min-height:80vh; }
.network-section { flex:2; padding:30px; background:#fff; border-right:1px solid #e1e5f2; }
.info-panel { flex:1; background:#fff; padding:30px; }
.network-container { position:relative; width:100%; height:500px; background:#fff; border:2px solid #e1e5f2; border-radius:12px; overflow:hidden; }
.network-svg { width:100%; height:100%; }
.node { cursor:pointer; transition:all .3s ease; }
.node.clickable:hover { stroke:#540b0e; stroke-width:3; }
.node-clickarea { fill:transparent; cursor:pointer; }
.node.selected { stroke:#3d5a80; stroke-width:4; }
.node.user { fill:#022b3a; }
.node.supplier { fill:#1f7a8c; }
.node.supplier.selected-supplier { fill:#bfdbf7; stroke:#1f7a8c; stroke-width:4; }
.node.threepl { fill:#bfdbf7; }
.edge { stroke:#e1e5f2; stroke-width:2; fill:none; }
.edge.active { stroke:#3d5a80; stroke-width:3; }
.node-label { font-size:12px; fill:#fff; text-anchor:middle; dominant-baseline:central; font-weight:600; }
.info-card { background:#fff; border:1px solid #e1e5f2; border-radius:12px; padding:20px; margin-bottom:20px; box-shadow:0 2px 8px rgba(31,122,140,.1); }
.info-card h3 { color:#022b3a; margin-bottom:15px; font-size:1.2rem; }
.attribute { display:flex; justify-content:space-between; margin-bottom:8px; padding:8px 0; border-bottom:1px solid #e1e5f2; }
.attribute:last-child { border-bottom:none; }
.attribute-label { font-weight:500; color:#022b3a; }
.attribute-value { color:#1f7a8c; font-weight:600; }
.selection-section { margin-top:30px; }
.select-button { width:100%; background:#1f7a8c; color:#fff; border:none; padding:15px 20px; border-radius:8px; font-size:1rem; font-weight:600; cursor:pointer; transition:all .3s ease; margin-bottom:10px; }
.select-button:hover { background:#022b3a; transform:translateY(-1px); }
.select-button:disabled { background:#e1e5f2; color:#bfdbf7; cursor:not-allowed; transform:none; }
.confidence-section { margin-top:20px; }
.confidence-slider { width:100%; margin:10px 0; appearance:none; height:6px; border-radius:3px; background:#e1e5f2; outline:none; }
.confidence-slider::-webkit-slider-thumb { appearance:none; width:20px; height:20px; border-radius:50%; background:#1f7a8c; cursor:pointer; }
.confidence-slider::-moz-range-thumb { width:20px; height:20px; border-radius:50%; background:#1f7a8c; cursor:pointer; border:none; }
.confidence-labels { display:flex; justify-content:space-between; font-size:.8rem; color:#1f7a8c; }
.navigation-buttons { display:flex; gap:10px; margin-top:30px; }
.nav-button { flex:1; padding:12px 20px; border:2px solid #1f7a8c; border-radius:8px; font-weight:600; cursor:pointer; transition:all .3s ease; }
.nav-button.primary { background:#1f7a8c; color:#fff; }
.nav-button.secondary { background:#fff; color:#1f7a8c; }
.nav-button:hover { background:#022b3a; border-color:#022b3a; color:#fff; }
.nav-button:disabled { background:#e1e5f2; border-color:#e1e5f2; color:#bfdbf7; cursor:not-allowed; }
.additional-info { background:#bfdbf7; padding:15px; border-radius:8px; margin-top:15px; font-size:.9rem; }
.results-section { text-align:center; padding:40px; }
.download-button { background:#1f7a8c; color:#fff; border:none; padding:15px 30px; border-radius:8px; font-size:1.1rem; font-weight:600; cursor:pointer; margin:10px; transition:all .3s ease; }
.download-button:hover { background:#022b3a; transform:translateY(-2px); }
.hidden { display:none; }
@media (max-width:768px){ .main-content{flex-direction:column;} .network-section{border-right:none; border-bottom:1px solid #e1e5f2;} .scenario-info{flex-direction:column; gap:10px; text-align:center;} .chevron{width:120px; font-size:.8rem;} }
</style>
</head>
<body>
<div class="container">
  <header class="header">
    <h1>Supplier Selection Research Study</h1>
    <p>Choose the best supplier option each week</p>
  </header>

  <div class="scenario-bar">
    <div class="scenario-info">
      <div class="week-info">
        <div class="week-badge" id="weekBadge">Week 1</div>
        <div class="scenario-description" id="scenarioDescription">Standard supplier information available</div>
      </div>
      <div class="chevron-progress">
        <div class="chevron-container">
          <div class="chevron baseline active" id="chevron0">
            Baseline
            <div class="chevron-progress-bar"><div class="chevron-progress-fill" id="chevronProgress0" style="width:0%"></div></div>
          </div>
        </div>
        <div class="chevron-container">
          <div class="chevron locked" id="chevron1"> Transparency
            <div class="chevron-progress-bar"><div class="chevron-progress-fill" id="chevronProgress1" style="width:0%"></div></div>
          </div>
        </div>
        <div class="chevron-container">
          <div class="chevron locked" id="chevron2"> Reputation
            <div class="chevron-progress-bar"><div class="chevron-progress-fill" id="chevronProgress2" style="width:0%"></div></div>
          </div>
        </div>
        <div class="chevron-container">
          <div class="chevron locked" id="chevron3"> Verification
            <div class="chevron-progress-bar"><div class="chevron-progress-fill" id="chevronProgress3" style="width:0%"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="network-section">
      <h2 style="margin-bottom:20px; color:#022b3a;">Supply Network</h2>
      <div class="network-container">
        <svg class="network-svg" id="networkSvg"></svg>
      </div>
    </div>
    <div class="info-panel">
      <div id="nodeInfo" class="info-card">
        <h3>Select a supplier or 3PL to view details</h3>
        <p style="color:#1f7a8c;">Click on the network nodes to explore your options.</p>
      </div>
      <div id="selectionSection" class="selection-section hidden">
        <button id="selectButton" class="select-button" onclick="selectSupplier()">Select This Supplier</button>
        <div class="confidence-section">
          <label for="confidenceSlider" style="font-weight:600; color:#022b3a;">Confidence in this decision:</label>
          <input type="range" id="confidenceSlider" class="confidence-slider" min="1" max="7" value="4">
          <div class="confidence-labels"><span>Very Low</span><span>Neutral</span><span>Very High</span></div>
        </div>
      </div>
      <div class="navigation-buttons">
        <button id="nextButton" class="nav-button primary" onclick="nextWeek()" disabled>Confirm Selection & Continue</button>
      </div>
    </div>
  </div>

  <div id="resultsSection" class="results-section hidden">
    <h2 style="color:#022b3a; margin-bottom:20px;">Study Complete!</h2>
    <p style="margin-bottom:30px; color:#1f7a8c;">Thank you for participating. Your data has been recorded.</p>
    <button class="download-button" onclick="downloadResults()">Download Results (CSV)</button>
    <button class="download-button" onclick="downloadResultsJSON()">Download Results (JSON)</button>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const COLLECTOR_URL = 'https://script.google.com/macros/s/AKfycbzl6WD_QOcD_j06W0n1q6FgLAcHt0vYUqrVbJgssYQXuDIJiytvkwxplJOR1Z76Z5v_5g/exec'; //

/* ====== PERMS (client mirror, used for fallback only) ====== */
const PERMS = [
  [1,2,3],[1,3,2],[2,1,3],
  [2,3,1],[3,1,2],[3,2,1]
];

function hashToArm(s){
  let h=0; for(let i=0;i<s.length;i++) h=(h*31 + s.charCodeAt(i))>>>0;
  return h%6;
}

/* ====== DATA ====== */
let participantData = {
  version:'v1.1-assigner',
  participantId:'P'+Date.now(),
  startTimeISO:new Date().toISOString(),
  startTimeMs:Date.now(),
  layoutSeed: Math.floor(Math.random()*1e9),
  decisions:[],
  interactions:[],
  currentWeek:1,
  currentScenario:0, // 0..3 (Baseline + 3 regimes)
  selectedNode:null,
  order:[],
  uploadStatus:null
};

let scenarioOrder = null;

/* ====== SUPPLIERS / SCENARIOS / NETWORK (unchanged) ====== */
const supplierProfiles = {
  'A': { name:'Supplier A', type:'supplier', baseAttributes:{
    'Relationship':'New market entrant','Service Level Agreement':'90%','Lead Time':'Slow','Certifications':'High quality certifications'}},
  'B': { name:'Supplier B', type:'supplier', baseAttributes:{
    'Relationship':'Established','Service Level Agreement':'80%','Lead Time':'Fast','Certifications':'Basic certifications'}},
  'C': { name:'Supplier C', type:'supplier', baseAttributes:{
    'Relationship':'Established','Service Level Agreement':'85%','Lead Time':'Medium','Certifications':'Standard certifications'}},
  'D': { name:'Supplier D', type:'supplier', baseAttributes:{
    'Relationship':'New partnership','Service Level Agreement':'95%','Lead Time':'Very Fast','Certifications':'Premium certifications'}},
  'F1': { name:'3PL A', type:'threepl', baseAttributes:{
    'Service Range':'Consolidation terminal','Experience':'Established','Suppliers Managed':'Multiple suppliers','Coverage':'Regional'}},
  'F2': { name:'3PL B', type:'threepl', baseAttributes:{
    'Service Range':'Basic logistics','Experience':'New service','Suppliers Managed':'Single supplier exclusive','Coverage':'Local'}}
};

const scenarios = [
  { name:'Baseline', description:'Standard supplier information available', additionalInfo:{} },
  { name:'Transparency', description:'Real-time operational data available', additionalInfo:{
    'A':{'Current Inventory':'High stock available','Processing Queue':'2 days backlog','Active Orders':'12 orders in production','Delivery Status':'On schedule for next shipment'},
    'B':{'Current Inventory':'Medium stock levels','Processing Queue':'4 hours to process','Active Orders':'8 orders in production','Delivery Status':'3 shipments departed today'},
    'F1':{'Active Connections':'5 suppliers currently connected','Live Tracking':'23 shipments in transit','Coordination Status':'Multi-modal logistics active','Current Capacity':'78% utilization'},
    'F2':{'Active Connections':'1 exclusive supplier online','Live Tracking':'4 shipments in transit','Coordination Status':'Direct routing only','Current Capacity':'45% utilization'}
  }},
  { name:'Reputation', description:'Aggregated ratings and peer reviews available', additionalInfo:{
    'A':{'Contractor Rating':'4.2/5 (78)','Delivery Rating':'3.8/5','Quality Rating':'4.6/5','Recent Feedback':'"Reliable but slower delivery"'},
    'B':{'Contractor Rating':'4.7/5 (124)','Delivery Rating':'4.8/5','Quality Rating':'4.1/5','Recent Feedback':'"Fast delivery, consistent"'},
    'F1':{'Service Rating':'4.6/5','Client Retention':'85%','Project Completion':'92% on-time','Testimonial':'"Excellent coordination"'},
    'F2':{'Service Rating':'3.2/5','Client Retention':'45%','Project Completion':'67% on-time','Testimonial':'"Basic service"'}
  }},
  { name:'Verification', description:'Certification and compliance verification available', additionalInfo:{
    'A':{'SLA Verification':'Verified: 90.2%','Certificate Status':'ISO 9001 (Dec 2026)','Compliance Audit':'PASS (minor)','Claims Verified':'✓ capacity confirmed'},
    'B':{'SLA Verification':'Verified: 79.8%','Certificate Status':'Basic: valid','Compliance Audit':'PASS (none)','Claims Verified':'✓ capacity confirmed'},
    'F1':{'Partnership Auth':'✓ 5 partnerships','Compliance Status':'All current','Network Verification':'✓ multi-supplier','Audit Status':'Annual verified'},
    'F2':{'Partnership Auth':'✓ 1 exclusive','Compliance Status':'Basic only','Network Verification':'✓ single','Audit Status':'Limited'}
  }}
];

const networkNodes = {
  'User': { x:100, y:250, type:'user', label:'You' },
  'A': { x:400, y:120, type:'supplier', label:'Supplier A', clickable:true },
  'B': { x:400, y:380, type:'supplier', label:'Supplier B', clickable:true },
  'F1': { x:300, y:200, type:'threepl', label:'3PL A', clickable:true },
  'F2': { x:300, y:300, type:'threepl', label:'3PL B', clickable:true },
  'C': { x:600, y:120, type:'supplier', label:'Supplier C', clickable:false },
  'D': { x:600, y:380, type:'supplier', label:'Supplier D', clickable:false }
};
const networkEdges = [
  { from:'User', to:'A' }, { from:'User', to:'B' },
  { from:'User', to:'F1' }, { from:'User', to:'F2' },
  { from:'F1', to:'C' }, { from:'F2', to:'B' }, { from:'F2', to:'D' }
];

/* ====== ASSIGNMENT ====== */
async function assignArmFromServer(){
  try{
    const r = await fetch(COLLECTOR_URL, { method:'GET' });
    const j = await r.json();
    if (j && j.ok && Number.isInteger(j.arm) && j.arm>=0 && j.arm<=5) {
      const tail = j.order && j.order.length===4 ? j.order.slice(1) : PERMS[j.arm];
      scenarioOrder = [0, ...tail];
      participantData.order = scenarioOrder.slice();
      return;
    }
  }catch(_e){ /* fall back */ }
  // Fallback: deterministic hash (single link, no counter)
  const arm = hashToArm(participantData.participantId);
  scenarioOrder = [0, ...PERMS[arm]];
  participantData.order = scenarioOrder.slice();
}

function currentScenarioObj(){
  const actualIndex = scenarioOrder[participantData.currentScenario];
  return scenarios[actualIndex];
}

/* ====== NETWORK RENDER ====== */
function initializeNetwork() {
  const svg = document.getElementById('networkSvg');
  svg.innerHTML = '';

  networkEdges.forEach(edge => {
    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',networkNodes[edge.from].x);
    line.setAttribute('y1',networkNodes[edge.from].y);
    line.setAttribute('x2',networkNodes[edge.to].x);
    line.setAttribute('y2',networkNodes[edge.to].y);
    line.setAttribute('class','edge');
    line.setAttribute('data-edge',`${edge.from}-${edge.to}`);
    svg.appendChild(line);
  });

  Object.entries(networkNodes).forEach(([id,node])=>{
    const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
    circle.setAttribute('cx',node.x); circle.setAttribute('cy',node.y);
    circle.setAttribute('r', node.type==='user'?25:30);
    circle.setAttribute('class',`node ${node.type}${node.clickable!==false?' clickable':''}`);
    circle.setAttribute('data-node',id);
    svg.appendChild(circle);

    if (node.type!=='user' && node.clickable!==false){
      const clickArea = document.createElementNS('http://www.w3.org/2000/svg','circle');
      clickArea.setAttribute('cx',node.x); clickArea.setAttribute('cy',node.y);
      clickArea.setAttribute('r',45); clickArea.setAttribute('class','node-clickarea');
      clickArea.setAttribute('data-node',id);
      clickArea.addEventListener('click',()=>selectNode(id));
      clickArea.addEventListener('mouseenter',()=>{ circle.style.stroke='#540b0e'; circle.style.strokeWidth='3'; });
      clickArea.addEventListener('mouseleave',()=>{ if(!circle.classList.contains('selected')){ circle.style.stroke=''; circle.style.strokeWidth=''; }});
      svg.appendChild(clickArea);
    }

    const text = document.createElementNS('http://www.w3.org/2000/svg','text');
    text.setAttribute('x',node.x); text.setAttribute('y',node.y); text.setAttribute('class','node-label');
    text.textContent=node.label; svg.appendChild(text);
  });
}

/* ====== UI ====== */
function relabelChevronsForOrder(){
  // chevron0 is always baseline
  const els = [
    document.getElementById('chevron0'),
    document.getElementById('chevron1'),
    document.getElementById('chevron2'),
    document.getElementById('chevron3')
  ];
  els[0].childNodes[0].nodeValue = ' Baseline ';
  for (let i=1;i<=3;i++){
    const scIndex = scenarioOrder[i];
    const name = scenarios[scIndex].name;
    els[i].childNodes[0].nodeValue = ' ' + name + ' ';
  }
}

function updateUI() {
  const sc = currentScenarioObj();
  const weekProgress = ((participantData.currentWeek - 1) / 4) * 100;

  document.getElementById('weekBadge').textContent = `Week ${participantData.currentWeek}`;
  document.getElementById('scenarioDescription').textContent = sc.description;

  for (let i=0;i<4;i++){
    const chevron = document.getElementById(`chevron${i}`);
    const progressBar = document.getElementById(`chevronProgress${i}`);
    if (i < participantData.currentScenario){
      chevron.className = 'chevron completed';
      progressBar.style.width = '100%';
    } else if (i === participantData.currentScenario){
      chevron.className = `chevron active${i===0?' baseline':''}`;
      progressBar.style.width = `${weekProgress}%`;
    } else {
      chevron.className = 'chevron locked';
      progressBar.style.width = '0%';
    }
  }
}

/* ====== INTERACTION ====== */
function selectNode(nodeId) {
  const now = Date.now();
  const last = participantData.lastActionTime ?? participantData.startTimeMs;
  participantData.interactions.push({
    timestamp: new Date().toISOString(),
    week: participantData.currentWeek,
    scenario: participantData.currentScenario,
    action: 'node_click',
    nodeId,
    timeOnPage: now - last
  });
  participantData.lastActionTime = now;

  document.querySelectorAll('.node').forEach(n=>n.classList.remove('selected'));
  document.querySelectorAll('.edge').forEach(e=>e.classList.remove('active'));

  const selectedNode = document.querySelector(`[data-node="${nodeId}"]`);
  if (selectedNode) selectedNode.classList.add('selected');

  networkEdges.forEach(edge=>{
    if (nodeId==='B' && edge.from==='F2' && edge.to==='B') return;
    if (edge.from===nodeId || edge.to===nodeId){
      const el = document.querySelector(`[data-edge="${edge.from}-${edge.to}"]`);
      if (el) el.classList.add('active');
    }
  });

  displayNodeInfo(nodeId);
  participantData.selectedNode = nodeId;

  const profile = supplierProfiles[nodeId];
  if (profile){
    document.getElementById('selectionSection').classList.remove('hidden');
    const btn = document.getElementById('selectButton');
    btn.textContent = `Select ${profile.name}`;
    btn.disabled = false;
  }
}

function displayNodeInfo(nodeId) {
  const profile = supplierProfiles[nodeId];
  if (!profile) return;
  const infoDiv = document.getElementById('nodeInfo');
  const sc = currentScenarioObj();

  let html = `<h3>${profile.name}</h3>`;
  Object.entries(profile.baseAttributes).forEach(([k,v])=>{
    html += `<div class="attribute"><span class="attribute-label">${k}:</span><span class="attribute-value">${v}</span></div>`;
  });
  if (sc.additionalInfo[nodeId]){
    html += '<div class="additional-info"><strong>Additional Information:</strong>';
    Object.entries(sc.additionalInfo[nodeId]).forEach(([k,v])=>{
      html += `<div class="attribute"><span class="attribute-label">${k}:</span><span class="attribute-value">${v}</span></div>`;
    });
    html += '</div>';
  }
  infoDiv.innerHTML = html;
}

function selectSupplier() {
  if (!participantData.selectedNode) return;
  const now = Date.now();
  const last = participantData.lastActionTime ?? participantData.startTimeMs;
  const conf = document.getElementById('confidenceSlider').value;
  const sc = currentScenarioObj();

  participantData.decisions.push({
    week: participantData.currentWeek,
    scenario: participantData.currentScenario,
    scenarioName: sc.name,
    selectedSupplier: participantData.selectedNode,
    supplierName: supplierProfiles[participantData.selectedNode].name,
    supplierType: supplierProfiles[participantData.selectedNode].type,
    confidence: parseInt(conf),
    timestamp: new Date().toISOString(),
    decisionTime: now - last
  });

  document.getElementById('nextButton').disabled = false;
  const btn = document.getElementById('selectButton');
  btn.disabled = true;
  btn.textContent = `${supplierProfiles[participantData.selectedNode].name} Selected ✓`;
}

async function nextWeek(){
  participantData.currentWeek++;

  document.querySelectorAll('.node').forEach(n=>n.classList.remove('selected'));
  document.getElementById('selectionSection').classList.add('hidden');
  document.getElementById('nodeInfo').innerHTML = `
    <h3>Select a supplier or 3PL to view details</h3>
    <p style="color:#1f7a8c;">Click on the network nodes to explore your options.</p>`;
  document.getElementById('nextButton').disabled = true;
  document.getElementById('confidenceSlider').value = 4;
  participantData.selectedNode = null;

  if (participantData.currentWeek > 4){
    participantData.currentWeek = 1;
    participantData.currentScenario++;
    if (participantData.currentScenario >= 4){
      await showResults();
      return;
    }
  }
  updateUI();
}

/* ====== RESULTS / EXPORT ====== */
async function uploadResults(){
  try{
    const r = await fetch(COLLECTOR_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(participantData)
    });
    participantData.uploadStatus = r.ok ? 'ok' : 'fail';
  }catch(_e){ participantData.uploadStatus = 'fail'; }
}

async function showResults(){
  document.querySelector('.main-content').classList.add('hidden');
  document.getElementById('resultsSection').classList.remove('hidden');
  participantData.endTime = new Date().toISOString();
  participantData.totalDurationMs = Date.now() - participantData.startTimeMs;
  await uploadResults(); // non-blocking UX already switched to results screen
}

function convertToCSV(data){
  const headers = ['ParticipantID','Week','ScenarioPos','ScenarioName','SelectedSupplier','SupplierName','SupplierType','Confidence','DecisionTimeMs','Timestamp','Order'];
  let csv = headers.join(',') + '\n';
  data.decisions.forEach(d=>{
    csv += [
      data.participantId, d.week, d.scenario, `"${d.scenarioName}"`,
      d.selectedSupplier, `"${d.supplierName}"`, d.supplierType,
      d.confidence, d.decisionTime, d.timestamp, `"${(data.order||[]).join('-')}"`
    ].join(',') + '\n';
  });
  csv += '\n\nInteraction Data:\n';
  csv += 'ParticipantID,Timestamp,Week,ScenarioPos,Action,NodeID,TimeOnPageMs,Order\n';
  data.interactions.forEach(x=>{
    csv += [
      data.participantId, x.timestamp, x.week, x.scenario, x.action,
      x.nodeId || '', x.timeOnPage || '', `"${(data.order||[]).join('-')}"`
    ].join(',') + '\n';
  });
  return csv;
}

function downloadResults(){
  const csv = convertToCSV(participantData);
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.style.display='none'; a.href=url; a.download=`supplier_study_${participantData.participantId}.csv`;
  document.body.appendChild(a); a.click(); URL.revokeObjectURL(url);
}

function downloadResultsJSON(){
  const json = JSON.stringify(participantData, null, 2);
  const blob = new Blob([json], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.style.display='none'; a.href=url; a.download=`supplier_study_${participantData.participantId}.json`;
  document.body.appendChild(a); a.click(); URL.revokeObjectURL(url);
}

/* ====== INIT ====== */
async function init(){
  await assignArmFromServer();     // get rotating order (or fallback)
  relabelChevronsForOrder();       // set chevron labels to actual order
  initializeNetwork();
  updateUI();
  participantData.lastActionTime = Date.now();
}

window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>

